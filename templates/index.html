
<head>
    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link href = "{{ url_for('static', filename='css/index.css') }}" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v4.js"></script>
</head>
<body>  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
      Select Samples
    </button>



    <div class="main">
      <div class="heatmap" id="heatmap"></div>
      <div class="local_view" id="local_view">
        <!-- <div class="local_snap" id="local_left" style="float:left">

        </div>
        <div class="local_snap" id="local_right" style="float:right">
        </div> -->
      </div>
      <div class="img_grid" id="img_grid"></div>
    </div>
    
    <!-- img selection -->
    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true" style="width:80vw">
      <div class="modal-dialog modal-xl modal-dialog-scrollable" style="width:80vw">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="staticBackdropLabel">Select Samples</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              {%for i in range(0, len)%}
                  <!-- <a onclick="select_im" data-arg1=i> -->

                      {% set function_i = "select_im("+ ids[i] + ")" %}
                      <img class="sel_im" src={{samples[i]}} id={{ids[i]}} alt="" width="150px" height="150px" onclick={{function_i}} data-arg1=i>
              {%endfor%}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-info" id="selectall_button">Select All</button>
            <button type="button" class="btn btn-secondary" id="unselect_button">Unselect all</button>
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="visualize_button">Select</button>
          </div>
        </div>
      </div>
    </div>      
  </div>      
    </div>      
  </div>      
    </div>      

  <script>

      // global vars
      var SELECTED = [];
      var DATA = [];
      var NEIGHBOURS = [];
      var LOCAL_IMG = -1;
      var DISTANCE_ENTRY = -1;
      var LOCAL_IMG_WIDTH = 75;
      var LOCAL_NUM_NEIGHBOURS = 4;

      /* select imgs to build heat map (from modal) */
      function select_im(i) {
        //selection mechanism
        var index = SELECTED.indexOf(i);
        // if img already SELECTED, unselect
        if (index > -1) {
          SELECTED.splice(index, 1);
          var element = document.getElementById(i);
          element.style.border = "0px";
        }
        // select img
        else {
          SELECTED.push(i);
          var element = document.getElementById(i);
          element.style.border = "10px solid red";
        }
      }

      // select all imgs
      $("#selectall_button").click(function(){
        SELECTED = [];
        $(".sel_im").each(function(i, x){
          this.style.border = "10px solid red";
          SELECTED.push(this.id);
        });
      });

      // unselect all SELECTED items
      $("#unselect_button").click(function(){
        $(".sel_im").each(function(){
          this.style.border = "0px";
        });
        SELECTED = [];
      });

      /*main view 
        1. display SELECTED imgs 
        2. request data from python
        3. build heatmap
      */
      
      $("#visualize_button").click(function(){
        $.ajax({ async: false,
          url:'{{url_for("array_post")}}',
          type:'post',
          data:{selected:SELECTED},
          success:function(res){
          }
          
        });
        // request SELECTED data from python and build the heatmap
        $.get('{{url_for("array_post")}}', function( data ) {
            DATA = data.mat;
            NEIGHBOURS = data.neighbours;
            build_heatmap();
        });
    });

    // select all imgs
    $("#selectall_button").click(function(){
        SELECTED = [];
        $(".sel_im").each(function(i, x){
          this.style.border = "10px solid red";
          SELECTED.push(this.id);
        });
      });

    // unselect all SELECTED items
    $("#unselect_button").click(function(){
      $(".sel_im").each(function(){
        this.style.border = "0px";
      });
      SELECTED = [];
    });

    // visualize local relationships
    function select_local_img(x, img){
      // remove heatmap selection
      if (DISTANCE_ENTRY != -1) {
        var distance_sel = document.getElementById(DISTANCE_ENTRY)
        distance_sel.style.stroke = "none";
        distance_sel.style.stroke = 0.9;
        DISTANCE_ENTRY = -1;
      }
     
      // clear
      d3.selectAll(".local_img")
        .remove();


      //unselect feature
      if (LOCAL_IMG == x) {
        var unselect = document.getElementById("local"+x);
        unselect.style.outline = "0px";
        LOCAL_IMG = -1;
      }
      else  {
        // if there already was a local img selected
        if (LOCAL_IMG != -1){
          var prev = document.getElementById("local"+LOCAL_IMG);
          prev.style.outline = "0px";
        }
        LOCAL_IMG = x;
        img.style.outline = "5px solid red";

        // get local views
        var local_view = document.getElementById("local_view");
        var disp_img = document.getElementById(x);

        // dynamically adjust size of heatmap
        var width =  local_view.getBoundingClientRect().width;
        var height = local_view.getBoundingClientRect().height;

        // clear previous plot
        d3.select("#local_view")
           .selectAll("*").remove();

        svg = d3.select("#local_view")
                .append("svg")
                  .attr("width", width)
                  .attr("height", height)
                  .attr("style", "outline: thin solid red;")
                  .append("g")
                    .attr("id", "local_view_svg")
                      .attr("width", width)
                      .attr("height", height);
                
        // display selected image 
      
        // locations for imgs
        var x_l = width/4;
        var x_r = (x_l * 3) - (LOCAL_IMG_WIDTH/2);
        x_l = x_l - (LOCAL_IMG_WIDTH/2);
        var y_l = height/2 - (LOCAL_IMG_WIDTH/2);

        // left img
        svg
          .append('image')
            .attr('xlink:href', disp_img.src)
            .attr("class", "local_img")
            .attr("id", "local_img_l")
            .attr('x', x_l)
            .attr('y', y_l)
            .attr("width", LOCAL_IMG_WIDTH)
            .attr("height", LOCAL_IMG_WIDTH)

        // right img
        svg
          .append('image')
            .attr('xlink:href', disp_img.src)
            .attr("class", "local_img")
            .attr("id", "local_img_r")
            .attr('x', x_r)
            .attr('y', y_l)
            .attr("width", LOCAL_IMG_WIDTH)
            .attr("height", LOCAL_IMG_WIDTH)
      }
    }

    window.addEventListener('resize', build_heatmap);


    function build_heatmap() {
        
        // dynamically adjust size of heatmap
        var width =  document.getElementById("heatmap").getBoundingClientRect().width;
        var height = document.getElementById("heatmap").getBoundingClientRect().height;

        // set the dimensions and margins of the graph
        var margin = {top: 80, right: 25, bottom: 30, left: 40},
          width = width - margin.left - margin.right,
          height = height - margin.top - margin.bottom;

        // clear previous heatmap
        d3.select("#heatmap")
           .selectAll("*").remove();

        // append the svg object to the body of the page
        var svg = d3.select("#heatmap")
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
        .append("g")
          .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

        
        // Labels of row and columns -> unique identifier of the column called 'group' and 'variable'
        var Cols = d3.map(DATA, function(d){return d.col;}).keys().reverse();
        var Rows = d3.map(DATA, function(d){return d.row;}).keys();

        // Build X scales and axis:
        var x = d3.scaleBand()
          .range([ 0, width ])
          .domain(Cols)
          .padding(0.05);
        svg.append("g")
          .style("font-size", 15)
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x).tickSize(0))
          .select(".domain").remove()

        // Build Y scales and axis:
        var y = d3.scaleBand()
          .range([ height, 0 ])
          .domain(Rows)
          .padding(0.05);
        svg.append("g")
          .style("font-size", 15)
          .call(d3.axisLeft(y).tickSize(0))
          .select(".domain").remove()

        var myColor = d3.scaleSequential()
          .interpolator(d3.interpolateInferno)
          .domain([d3.min(DATA, (d)=>{return d.distance;}), d3.max(DATA, (d)=>{return d.distance;})]);

        
        var mouseover = function(d) {
          // visualize the selected imgs based on confidence
          if (DISTANCE_ENTRY == -1) {
            // clear the img plot
            var img_grid = document.getElementById("img_grid");
            img_grid.innerHTML = "";

            //compute mins and maxs
            var confidences = []
            for (const [key, value] of Object.entries(NEIGHBOURS[this.id.split(":")[0]])) {
              confidences.push(value["confidence"]);
            }
            for (const [key, value] of Object.entries(NEIGHBOURS[this.id.split(":")[1]])) {
              confidences.push(value["confidence"]);
            }
            
            var img_grid_w = img_grid.getBoundingClientRect().width;
            var img_grid_h = img_grid.getBoundingClientRect().height;

            var margin = {top: 80, right: 25, bottom: 30, left: 40},
            img_grid_w = img_grid_w - margin.left - margin.right,
            img_grid_h = img_grid_w - margin.top - margin.bottom;

            var conf_scale = d3.scaleLinear()
                  .domain([d3.min(confidences),
                            d3.max(confidences)])
                  .range([0, d3.min([img_grid_h, img_grid_w])*0.6])
          
            // build svg
            var img_grid_svg = d3.select("#img_grid")
              .append('svg')
              .attr("id", "img_grid_svg")
              .attr('width', img_grid_w + margin.left + margin.right)
              .attr('height', img_grid_h  + margin.top + margin.bottom)
            // build x-axis
            img_grid_svg.append("g")
              .style("font-size", 15)
              .attr("transform", "translate(0," + img_grid_h +")")
              .call(d3.axisBottom(conf_scale).tickSize(0))
              .select(".domain").remove()
            
            //build y axis 
            img_grid_svg.append("g")
              .style("font-size", 15)
              .call(d3.axisLeft(conf_scale).tickSize(0))
              .select(".domain").remove()

            // build img plot
            img_grid_svg
              .selectAll('image')
                .data(SELECTED)
                  .enter()
                  .append('image')
                    .attr('xlink:href', function(d, i){
                      var disp_img = document.getElementById(d);
                      return disp_img.src;
                    })
                    .attr("id", function(d, i){ return "local"+d})
                    // x axis = t0, y axis = t1
                    .attr('x', (d) => {return conf_scale(NEIGHBOURS[this.id.split(":")[0]][d]["confidence"]);})
                    .attr('y', (d) => {return conf_scale(NEIGHBOURS[this.id.split(":")[1]][d]["confidence"]);})
                    .attr("width", "10px")
                    .attr("height", "10px")
                    .attr("onclick", function(d, i){ return "select_local_img(" + d + "," + "local"+d + ");"})
                    .style("outline", function(d,i) { 
                                                      if (d == LOCAL_IMG) {return "5px solid red";}
                                                      else {return "0px"}
                                                    })
                    .on("mouseover", function(d){ 
                      this.style.width = "100px";
                      this.style.height = "100px";
                      // insert img on top
                      var top = document.getElementById("img_grid_svg")[0];
                      this.parentNode.insertBefore(this, top);
                      
                    }  )
                    .on("mouseleave", function(d){ 
                      this.style.width = "10px";
                      this.style.height = "10px";
                    }  );
                  }
          
          if (this.id != DISTANCE_ENTRY) {
            d3.select(this)
              .style("stroke", "black")
              .style("opacity", 1)
          }
        }

        var mouseclick = function(d) {
          if (DISTANCE_ENTRY != -1) {
            if (DISTANCE_ENTRY == this.id) {
              d3.select(this)
                .style("stroke", "none")
                .style("opacity", 0.9)
              DISTANCE_ENTRY = -1
            }
            else {
              var element = document.getElementById(DISTANCE_ENTRY)
              d3.select(element)
                .style("stroke", "none")
                .style("opacity", 0.9)

              d3.select(this)
                .style("stroke", "red")
                .style("opacity", 1)
              DISTANCE_ENTRY = this.id;
            }
          }
          else {
              d3.select(this)
                .style("stroke", "red")
                .style("opacity", 1)
              DISTANCE_ENTRY = this.id;
          }
        }
        var mousemove = function(d) {
          if (LOCAL_IMG != -1) {

          // default starting point of imgs
          // get local views
          var local_view = document.getElementById("local_view");
          // dynamically adjust size of heatmap
          var width =  local_view.getBoundingClientRect().width;
          var height = local_view.getBoundingClientRect().height;

          // distance scale for visualziation
          var neighbours = NEIGHBOURS[this.id.split(":")[0]][LOCAL_IMG]["neighbours"]
                            .concat(NEIGHBOURS[this.id.split(":")[1]][LOCAL_IMG]["neighbours"]);
          
          // max height
          h_i = (height / 2 ) - LOCAL_IMG_WIDTH;
          var img_scale = d3.scaleLinear()
                  .domain([d3.min(neighbours, (d)=>{return d[1];}),
                            d3.max(neighbours, (d)=>{return d[1];})])
                  .range([0, h_i])

          

          function compute_xy(x_init, y_init, n){
              var angle = (360 / n.length);
              var angles = [];
              //console.log(n);
              for (var i = 0; i < n.length; i++) {
                var x = x_init + (img_scale(n[i][1]) * Math.cos(angle * i * (Math.PI/180))* (Math.PI/180));
                var y = y_init + (img_scale(n[i][1]) * Math.sin(angle * i * (Math.PI/180))* (Math.PI/180));
                angles.push([n[i][0], x, y]);
              }
              //console.log(angles);
          }
          // var sorted_neighbours = neighbours.sort(function(a,b) {return a[1] - b[1];});
          // var xy = compute_xy(0, 0, neighbours.slice(0, LOCAL_NUM_NEIGHBOURS));


          // locations for imgs
          var x_l = width/4;
          var x_r = (x_l * 3) - (LOCAL_IMG_WIDTH/2);
          x_l = x_l - (LOCAL_IMG_WIDTH/2);
          var y_l = height/2 - (LOCAL_IMG_WIDTH/2);
          
          // clear all previous neighbours
          d3.select("#local_view_svg")
            .selectAll(".neighbour_img").remove();
          d3.select("#local_view_svg")
            .selectAll(".neighbour_line").remove();


          // draw lines for t0
          var local_n = NEIGHBOURS[this.id.split(":")[0]][LOCAL_IMG]["neighbours"].slice(0, 4);
          // t0 vertical line
          d3.select("#local_view_svg")
            .append("line")
              .attr("class", "neighbour_line")
              .attr("y1", (y_l + (LOCAL_IMG_WIDTH/2)) - img_scale(local_n[0][1]) - LOCAL_IMG_WIDTH)
              .attr("x1", (x_l + (LOCAL_IMG_WIDTH/2)))
              .attr("y2", (y_l + (LOCAL_IMG_WIDTH/2)) + img_scale(local_n[1][1]) + LOCAL_IMG_WIDTH)
              .attr("x2", (x_l + (LOCAL_IMG_WIDTH/2)))
              .style("stroke", "black")
              .style("stroke-width", "2");
          // t1 horizontal line
          d3.select("#local_view_svg")
            .append("line")
              .attr("class", "neighbour_line")
              .attr("y1", (y_l + (LOCAL_IMG_WIDTH/2))+ "px")
              .attr("x1", (x_l + (LOCAL_IMG_WIDTH/2)) - img_scale(local_n[2][1]) - LOCAL_IMG_WIDTH+ "px")
              .attr("y2", (y_l + (LOCAL_IMG_WIDTH/2))+ "px")
              .attr("x2", (x_l + (LOCAL_IMG_WIDTH/2)) + img_scale(local_n[3][1]) + LOCAL_IMG_WIDTH+ "px")
              .style("stroke", "black")
              .style("stroke-width", "2");
          // display t0 images
          d3.select("#local_view_svg")
            .selectAll()
            .data(NEIGHBOURS[this.id.split(":")[0]][LOCAL_IMG]["neighbours"].slice(0, 4))
            .enter()
                .append("image")
                .attr("class", "neighbour_img")
                .attr("id", (d, i)=>{return "nl"+i})
                .attr('xlink:href', function (d, i){ 
                  var disp_img = document.getElementById(d[0]);
                  return disp_img.src;
                })
                // /positioning imgs based on distances
                .attr("y", (d, i) =>{
                      switch(i) {
                      case 0:
                        return  y_l + img_scale(d[1]) + LOCAL_IMG_WIDTH;
                      case 1:
                        return y_l - img_scale(d[1]) - LOCAL_IMG_WIDTH;
                      default:
                          return y_l
                      }})
                .attr("x", (d, i) =>{
                
                switch(i) {
                case 2:
                  return x_l + img_scale(d[1]) + LOCAL_IMG_WIDTH;
                case 3:
                  return x_l - img_scale(d[1]) - LOCAL_IMG_WIDTH;
                default:
                  return x_l
                }})
                .attr("width", LOCAL_IMG_WIDTH)
                .attr("height", LOCAL_IMG_WIDTH);

          // insert left img on top
          var local_l = document.getElementById("local_img_l");
          var neighbour_node = document.getElementById("nl0");
          local_l.parentNode.insertBefore(local_l, neighbour_node);

          // draw lines for t1
          var local_n = NEIGHBOURS[this.id.split(":")[1]][LOCAL_IMG]["neighbours"].slice(0, 4);
          // t1 vertical line
          d3.select("#local_view_svg")
            .append("line")
              .attr("class", "neighbour_line")
              .attr("y1", (y_l + (LOCAL_IMG_WIDTH/2)) - img_scale(local_n[0][1]) - LOCAL_IMG_WIDTH)
              .attr("x1", (x_r + (LOCAL_IMG_WIDTH/2)))
              .attr("y2", (y_l + (LOCAL_IMG_WIDTH/2)) + img_scale(local_n[1][1]) + LOCAL_IMG_WIDTH)
              .attr("x2", (x_r + (LOCAL_IMG_WIDTH/2)))
              .style("stroke", "black")
              .style("stroke-width", "2");
          // t1 horizontal line
          d3.select("#local_view_svg")
            .append("line")
              .attr("class", "neighbour_line")
              .attr("y1", (y_l + (LOCAL_IMG_WIDTH/2))+ "px")
              .attr("x1", (x_r + (LOCAL_IMG_WIDTH/2)) - img_scale(local_n[2][1]) - LOCAL_IMG_WIDTH+ "px")
              .attr("y2", (y_l + (LOCAL_IMG_WIDTH/2))+ "px")
              .attr("x2", (x_r + (LOCAL_IMG_WIDTH/2)) + img_scale(local_n[3][1]) + LOCAL_IMG_WIDTH+ "px")
              .style("stroke", "black")
              .style("stroke-width", "2");
            
          

          
          //display t1 images
          d3.select("#local_view_svg")
            .selectAll()
            .data(NEIGHBOURS[this.id.split(":")[1]][LOCAL_IMG]["neighbours"].slice(0, 4))
            .enter()
                .append("image")
                .attr("class", "neighbour_img")
                .attr("id", (d, i)=>{return "nr"+i})
                .attr('xlink:href', function (d, i){ 
                  var disp_img = document.getElementById(d[0]);
                  return disp_img.src;
                })
                // /positioning imgs based on distances
                .attr("y", (d, i) =>{
                      switch(i) {
                      case 0:
                        return  y_l + img_scale(d[1]) + LOCAL_IMG_WIDTH+ "px";
                      case 1:
                        return y_l - img_scale(d[1]) - LOCAL_IMG_WIDTH+ "px";
                      default:
                          return y_l
                      }})
                .attr("x", (d, i) =>{
                      switch(i) {
                      case 2:
                        return x_r + img_scale(d[1]) + LOCAL_IMG_WIDTH + "px";
                      case 3:
                        return x_r - img_scale(d[1]) - LOCAL_IMG_WIDTH + "px";
                      default:
                        return x_r
                }})
                .attr("width", LOCAL_IMG_WIDTH)
                .attr("height", LOCAL_IMG_WIDTH);
              }
        // insert right img on top
        var local_r = document.getElementById("local_img_r");
        var neighbour_node = document.getElementById("nr0");
        local_r.parentNode.insertBefore(local_r, neighbour_node);

        }
        var mouseleave = function(d) {
         
          if (this.id != DISTANCE_ENTRY) { 
            d3.select(this)
              .style("stroke", "none")
              .style("opacity", 0.9)
          }
         
        }

        // add the squares
        svg.selectAll()
          .data(DATA, function(d) {return d.col+':'+d.row;})
          .enter()
          .append("rect")
            .attr("x", function(d) { return x(d.col) })
            .attr("y", function(d) { return y(d.row) })
            // .attr("rx", 4)
            // .attr("ry", 4)
            .attr("width", x.bandwidth() )
            .attr("height", y.bandwidth() )
            .attr("id", function(d) {return d.col+':'+d.row;})
            .style("fill", function(d) { return myColor(d.distance)} )
            .style("stroke-width", 4)
            .style("stroke", "none")
            .style("opacity", 0.9)
          .on("mouseover", mouseover)
          .on("mousemove", mousemove)
          .on("mouseleave", mouseleave)
          .on("click", mouseclick)
    }

  // warn user before reloading
  window.onbeforeunload = function() {
      return "Data will be lost if you leave the page, are you sure?";
    };
  </script>
</body>