
<head>
    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link href = "{{ url_for('static', filename='css/index.css') }}" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v4.js"></script>
</head>
<body>  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
      Launch static backdrop modal
    </button>

    <div class="main">
      <div class="heatmap" id="heatmap">
      </div>
      <div class="local_view">
        <div class="local_snap" id="local_left" style="background-color:white;float:left">

        </div>
        <div class="local_snap" id="local_right" style="background-color:rgb(8, 8, 8);float:right">
        </div>
      </div>
      <div class="img_grid" id="img_grid">

      </div>

    </div>
    
    <!-- Modal -->
    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true" style="width:80vw">
      <div class="modal-dialog modal-xl modal-dialog-scrollable" style="width:80vw">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="staticBackdropLabel">Select Samples</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              {%for i in range(0, len)%}
                  <!-- <a onclick="select_im" data-arg1=i> -->

                      {% set function_i = "select_im("+ ids[i] + ")" %}
                      <img class="sel_im" src={{samples[i]}} id={{ids[i]}} alt="" width="150px" height="150px" onclick={{function_i}} data-arg1=i>
              {%endfor%}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-info" id="selectall_button">Select All</button>
            <button type="button" class="btn btn-secondary" id="unselect_button">Unselect all</button>
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="visualize_button">Select</button>
          </div>
        </div>
      </div>
    </div>      
  </div>      
    </div>      
  </div>      
    </div>      

  <script>
      // global vars
      var SELECTED = [];
      var DATA = [];
      var NEIGHBOURS = [];
      var LOCAL_IMG = -1;

      /*select imgs to build heat map*/
      function select_im(i) {
        //selection mechanism
        var index = SELECTED.indexOf(i);
        // if img already SELECTED, unselect
        if (index > -1) {
          SELECTED.splice(index, 1);
          var element = document.getElementById(i);
          element.style.border = "0px";
        }
        // select img
        else {
          SELECTED.push(i);
          var element = document.getElementById(i);
          element.style.border = "10px solid red";
        }
      }

      // select all imgs
      $("#selectall_button").click(function(){
        SELECTED = [];
        $(".sel_im").each(function(i, x){
          this.style.border = "10px solid red";
          SELECTED.push(this.id);
        });
      });

      // unselect all SELECTED items
      $("#unselect_button").click(function(){
        $(".sel_im").each(function(){
          this.style.border = "0px";
        });
        SELECTED = [];
      });

      /*main view 
        1. display SELECTED imgs 
        2. request data from python
        3. build heatmap
      */
      
      $("#visualize_button").click(function(){
        $.ajax({ async: false,
          url:'{{url_for("array_post")}}',
          type:'post',
          data:{selected:SELECTED},
          success:function(res){
            // remove all previously viewed elements
            var img_grid = document.getElementById("img_grid");
            img_grid.innerHTML = "";
            var img_left = document.getElementById("local_left");
            img_left.innerHTML = "";
            var img_right = document.getElementById("local_right");
            img_right.innerHTML = "";
            // reset LOCAL_IMG var
            LOCAL_IMG = -1;
            // display photos in bottom corner
            SELECTED.forEach((x, i) => {
              var img = document.createElement("img");
              var disp_img = document.getElementById(x);
              img.src = disp_img.src;
              img.id = "local"+x;
              img.setAttribute('onclick', "select_local_img(" + x + "," + img.id  + ");");
              var img_grid = document.getElementById("img_grid");
              img_grid.appendChild(img);
            });
          }
          
        });
        // request SELECTED data from python and build the heatmap
        $.get('{{url_for("array_post")}}', function( data ) {
            DATA = data.mat;
            NEIGHBOURS = data.neighbours;
            console.log(NEIGHBOURS)
            build_heatmap();
        });
    });

    // select all imgs
    $("#selectall_button").click(function(){
        SELECTED = [];
        $(".sel_im").each(function(i, x){
          this.style.border = "10px solid red";
          SELECTED.push(this.id);
        });
      });

    // unselect all SELECTED items
    $("#unselect_button").click(function(){
      $(".sel_im").each(function(){
        this.style.border = "0px";
      });
      SELECTED = [];
    });

    // visualize local relationships
    function select_local_img(x, img){
      console.log(x, img);
      if (LOCAL_IMG != -1){
        var prev = document.getElementById(LOCAL_IMG);
        // console.log(prev);
        prev.style.border = "0px";
      }
      LOCAL_IMG = img.id;
      img.style.border = "5px solid red";

      // display selected img in local view
      var local_img_right = document.createElement("img");
      var local_img_left = document.createElement("img");
      var disp_img = document.getElementById(x);
      local_img_right.src = disp_img.src;
      local_img_left.src = disp_img.src;
      // setup local view
      local_img_right.className = "local_img";
      local_img_left.className = " local_img";
      local_img_right.id = " local_img_r";
      local_img_left.id = " local_img_l";
      
      var local_view_left = document.getElementById("local_left");
      var local_view_right = document.getElementById("local_right");
      // clear
      local_view_left.innerHTML = "";
      local_view_right.innerHTML = "";
      // add new imgs
      local_view_left.append(local_img_left);
      local_view_right.append(local_img_right);

    }

    window.addEventListener('resize', build_heatmap);


    function build_heatmap() {
        
        // dynamically adjust size of heatmap
        var width =  document.getElementById("heatmap").getBoundingClientRect().width;
        var height = document.getElementById("heatmap").getBoundingClientRect().height;

        // set the dimensions and margins of the graph
        var margin = {top: 80, right: 25, bottom: 30, left: 40},
          width = width - margin.left - margin.right,
          height = height - margin.top - margin.bottom;

        // clear previous heatmap
        d3.select("#heatmap")
           .selectAll("*").remove();

        // append the svg object to the body of the page
        var svg = d3.select("#heatmap")
        .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
        .append("g")
          .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

        
        // Labels of row and columns -> unique identifier of the column called 'group' and 'variable'
        var Cols = d3.map(DATA, function(d){return d.col;}).keys().reverse();
        var Rows = d3.map(DATA, function(d){return d.row;}).keys();

        // Build X scales and axis:
        var x = d3.scaleBand()
          .range([ 0, width ])
          .domain(Cols)
          .padding(0.05);
        svg.append("g")
          .style("font-size", 15)
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x).tickSize(0))
          .select(".domain").remove()

        // Build Y scales and axis:
        var y = d3.scaleBand()
          .range([ height, 0 ])
          .domain(Rows)
          .padding(0.05);
        svg.append("g")
          .style("font-size", 15)
          .call(d3.axisLeft(y).tickSize(0))
          .select(".domain").remove()

        var myColor = d3.scaleSequential()
          .interpolator(d3.interpolateInferno)
          .domain([d3.min(DATA, (d)=>{return d.distance;}), d3.max(DATA, (d)=>{return d.distance;})]);

        // create a tooltip
        var tooltip = d3.select("#heatmap")
          .append("div")
          .style("opacity", 0)
          .attr("class", "tooltip")
          .style("background-color", "white")
          .style("border", "solid")
          .style("border-width", "2px")
          .style("border-radius", "5px")
          .style("padding", "5px")

        // Three function that change the tooltip when user hover / move / leave a cell
        var mouseover = function(d) {
          tooltip
            .style("opacity", 1)
          d3.select(this)
            .style("stroke", "black")
            .style("opacity", 1)
        }
        var mousemove = function(d) {
          tooltip
            //.html("The exact value of<br>this cell is: " + d.distance)
            .html("selected instance: "+ NEIGHBOURS[LOCAL_IMG])
            .style("left", (d3.mouse(this)[0]+70) + "px")
            .style("top", (d3.mouse(this)[1]) + "px")
            // console.log(LOCAL_IMG);
        }
        var mouseleave = function(d) {
          tooltip
            .style("opacity", 0)
          d3.select(this)
            .style("stroke", "none")
            .style("opacity", 0.9)
        }

        // add the squares
        svg.selectAll()
          .data(DATA, function(d) {return d.col+':'+d.row;})
          .enter()
          .append("rect")
            .attr("x", function(d) { return x(d.col) })
            .attr("y", function(d) { return y(d.row) })
            .attr("rx", 4)
            .attr("ry", 4)
            .attr("width", x.bandwidth() )
            .attr("height", y.bandwidth() )
            .style("fill", function(d) { return myColor(d.distance)} )
            .style("stroke-width", 4)
            .style("stroke", "none")
            .style("opacity", 0.9)
          .on("mouseover", mouseover)
          .on("mousemove", mousemove)
          .on("mouseleave", mouseleave)
    }

  // warn user before reloading
  window.onbeforeunload = function() {
      return "Data will be lost if you leave the page, are you sure?";
    };
  </script>
</body>